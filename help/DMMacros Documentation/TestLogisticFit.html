<!DOCTYPE html>

<html>
<head>
<title>%TestLogisticFit</title>
<style>
pre {display: block}
</style>
<body>
<h1>MACRO %TestLogisticFit</h1>
<pre>Version:                      1.07                                                                                      </pre>
<pre>Author:                       Daniel Mastropietro                                                                       </pre>
<pre>Created:                      28-May-03                                                                                 </pre>
<pre>Modified:                     15-Feb-2016 (previous: 16-Nov-2015)                                                            </pre>
<pre>SAS:                          v9.3                                                                                      </pre>
<pre>                                                                                                                        </pre>
<h3>DESCRIPTION:</h3>
<pre>Analiza el ajuste de un modelo de regresión logística a partir de gráficos                                                                                          </pre>
<pre>que involucran las probabilidades predichas por el modelo y un conjunto de                                                                                          </pre>
<pre>variables regresoras analizadas.                                                                                          </pre>
<pre>                                                                                                                        </pre>
<pre>En lo que sigue se indica con logit a la función:                                                                                          </pre>
<pre>                              logit(p) = log(p/(1-p)),                                                                  </pre>
<pre>donde log es el logaritmo natural.                                                                                          </pre>
<pre>                                                                                                                        </pre>
<pre>Los gráficos que la macro efectúa son:                                                                                          </pre>
<pre>1.- Logit de las probabilidades vs. distintos valores de una dada variable                                                                                          </pre>
<pre>regresora categorizada. En este gráfico se incluyen:                                                                                          </pre>
<pre>- Logit de la probabilidad predicha por el modelo para cada grupo de la                                                                                          </pre>
<pre>variable regresora categorizada. Se calcula como el logit del promedio                                                                                          </pre>
<pre>de las probabilidades predichas dentro de cada grupo.                                                                                          </pre>
<pre>- Logit de la probabilidad observada para cada grupo de la variable                                                                                          </pre>
<pre>regresora categorizada. Se calcula como el logit de la proporción de                                                                                          </pre>
<pre>observaciones, dentro de cada grupo, en que la variable respuesta es igual                                                                                          </pre>
<pre>al evento cuya probabilidad es modelada por la regresión.                                                                                          </pre>
<pre>Además, puede pedirse que se muestren barras de error entorno de estas dos                                                                                          </pre>
<pre>cantidades, con la idea de estudiar más en detalle la variabilidad de las                                                                                          </pre>
<pre>probabilidades predichas dentro de cada grupo de la variable regresora,                                                                                          </pre>
<pre>y de ver gráficamente el error asociado a la probabilidad observada.                                                                                          </pre>
<pre>El ancho de las barras mide la magnitud de:                                                                                          </pre>
<pre>- el desvío estándar de las probabilidades predichas para las distintas                                                                                          </pre>
<pre>observaciones dentro de cada grupo.                                                                                          </pre>
<pre>- el error estándar de la probabilidad observada.                                                                                          </pre>
<pre>                                                                                                                        </pre>
<pre>2.- Un gráfico de residuos estandarizados vs. cada variable regresora                                                                                          </pre>
<pre>categorizada. Los residuos estandarizados se calculan como la diferencia entre                                                                                          </pre>
<pre>la probabilidad observada y la probabilidad predicha para cada grupo de                                                                                          </pre>
<pre>la variable regresora categorizada y se estandariza por su desvío estándar.                                                                                          </pre>
<pre>                                                                                                                        </pre>
<pre>3.- Un Normal Q-Q plot de los residuos estandarizados, donde su distribución                                                                                          </pre>
<pre>se compara con la normal estándar.                                                                                          </pre>
<pre>                                                                                                                        </pre>
<pre>4.- Si es solicitado, un histograma con la distribución de los residuos                                                                                          </pre>
<pre>estandarizados.                                                                                                         </pre>
<pre>                                                                                                                        </pre>
<h3>USAGE:</h3>
<pre>%TestLogisticFit(                                                                                          </pre>
<pre>          data ,                        /* Input dataset */                                         </pre>
<pre>          target= ,                     /* Variable respuesta */                                    </pre>
<pre>          var= ,                        /* Lista con las variables regresoras (puede incluir la variable respuesta) */                              </pre>
<pre>          out= ,                        /* Raiz del nombre de los output datasets conteniendo lo que se grafica */                              </pre>
<pre>          outCat=                       ,                             /* Output dataset con las variables regresoras categorizadas */</pre>
<pre>          pred=p ,                      /* Variable que contiene las probabilidades predichas */                              </pre>
<pre>          event=1 ,                     /* Evento modelado por la regresion logistica */                              </pre>
<pre>          groups=10 ,                   /* Número de grupos en los que efectuar la categorización */                              </pre>
<pre>          percentiles= ,                /* Percentiles para la categorizacion */                              </pre>
<pre>          res=res ,                     /* Nombre a usar para la variable con el residuo estandarizado */                              </pre>
<pre>          suffixRes=0 ,                 /* Agregar la variable regresora como sufijo para la variable 'res'? */                              </pre>
<pre>          plot=0,                       /* Mostrar gráficos? */                                     </pre>
<pre>          histogram=0 ,                 /* Hacer el histograma de los residuos? */                              </pre>
<pre>          qqplot=1 ,                    /* Hacer el normal Q-Q plot de los residuos? */                              </pre>
<pre>          refline=3.3,                  /* Valor de la línea de referencia en el gráfico de los residuos */                              </pre>
<pre>          pointlabels=0,                /* Mostrar point labels? */                                 </pre>
<pre>          bars=0 ,                      /* Mostrar barras de error en los gráficos de probabilidades? */                              </pre>
<pre>          barwidth=1,                   /* Multiplicador para las barras de error */                              </pre>
<pre>          plotWhat=logit,               /* Graficar el logit(p) ó p en los gráficos del ajuste? */                              </pre>
<pre>          axisX= ,                      /* Axis statement a usar en el eje de las X en los gráficos */                              </pre>
<pre>          axisLogit= ,                  /* Axis statement a usar en el eje del logit en los gráficos */                              </pre>
<pre>          axisPred= ,                   /* Axis statement a usar en el eje de las probabilidades en los gráficos */                              </pre>
<pre>          axisRes= ,                    /* Axis statement a usar en el eje de los residuos en los gráficos */                              </pre>
<pre>          log=1);                       /* Mostrar mensajes en el log? */                              </pre>
<pre>                                                                                                    </pre>
<h3>REQUIRED PARAMETERS:</h3>
<pre>- data:                       Input dataset. Se supone que es un dataset generado por el output                                                            </pre>
<pre>                              statement del PROC LOGISTIC.                                                              </pre>
<pre>                              Puede recibir cualquier opción adicional como en cualquier opción                                                            </pre>
<pre>                              data= de SAS.                                                                             </pre>
<pre>                                                                                                                        </pre>
<pre>- var:                        Lista de variables, donde la primera es la variable respuesta del                                                            </pre>
<pre>                              modelo de regresion a analizar y las demas son las variables regresoras                                                            </pre>
<pre>                              respecto a las cuales se desea analizar el ajuste. Notar que no pueden                                                            </pre>
<pre>                              incluirse interacciones entre variables.                                                            </pre>
<pre>                              Las variables no tienen por qué haber sido incluidas en la regresión,                                                            </pre>
<pre>                              por lo que esta macro puede usarse para analizar si es necesario incluir                                                            </pre>
<pre>                              nuevas variables en la regresión.                                                            </pre>
<pre>                              Ej: y x1 x2.                                                                              </pre>
<pre>                                                                                                                        </pre>
<h3>OPTIONAL PARAMETERS:</h3>
<pre>- target:                     Variable respuesta dicotómica.                                                            </pre>
<pre>                              Si el parámetro es vacío, la variable respuesta es tomada del primer elemento                                                            </pre>
<pre>                              de la lista especificada en VAR.                                                            </pre>
<pre>                                                                                                                        </pre>
<pre>- out:                        Raiz a usar para los output datasets que contienen lo que se grafica.                                                            </pre>
<pre>                              Se genera un output dataset por cada variable regresora que aparece en                                                            </pre>
<pre>                              la lista de 'var'.                                                                        </pre>
<pre>                              Los nombres de las columnas de cada uno de estos datasets son:                                                            </pre>
<pre>                              - <variable regresora considerada>: sus valores estan categorizados.                                                            </pre>
<pre>                                                                                                                        </pre>
<pre>                              - <variable respuesta>_Mean: promedio de la variable respuesta en cada                                                            </pre>
<pre>                              grupo de la variable regresora.                                                            </pre>
<pre>                              - <variable respuesta>_Std: Error estándar de <variable respuesta>_Mean.                                                            </pre>
<pre>                              - <variable respuesta>_Lower: valor inferior del intervalo de ancho                                                            </pre>
<pre>                              'barwidth'*<variable respuesta>_Std.                                                            </pre>
<pre>                              - <variable respuesta>_Upper: valor superior del intervalo de ancho                                                            </pre>
<pre>                              'barwidth'*<variable respuesta>_Std.                                                            </pre>
<pre>                                                                                                                        </pre>
<pre>                              - <variable con probabilidad predicha>_Mean: promedio de las                                                            </pre>
<pre>                              probabilidades predichas dentro de cada grupo de la variable regresora.                                                            </pre>
<pre>                              - <variable con probabilidad predicha>_Std: Desvío estándar de                                                            </pre>
<pre>                              <variable respuesta>_Mean.                                                                </pre>
<pre>                              - <variable con probabilidad predicha>_Lower: valor inferior del                                                            </pre>
<pre>                              intervalo de ancho 'barwidth'*<variable con probabilidad predicha>_Std.                                                            </pre>
<pre>                              - <variable con probabilidad predicha>_Upper: valor superior del                                                            </pre>
<pre>                              intervalo de ancho 'barwidth'*<variable con probabilidad predicha>_Std.                                                            </pre>
<pre>                                                                                                                        </pre>
<pre>                              - logit_<variable respuesta>: logit(segunda columna).                                                            </pre>
<pre>                              - logit_<variable con probabilidad predicha>: logit(tercera columna).                                                            </pre>
<pre>                              - _N_: numero de observaciones en cada grupo de la variable regresora.                                                            </pre>
<pre>                              - <variable con residuo estandarizado> (default=res): residuo estandarizado,                                                            </pre>
<pre>                              donde el residuo es la diferencia entre la segunda y la tercera columna.                                                            </pre>
<pre>                                                                                                                        </pre>
<pre>- outCat:                     Output dataset con las variables regresoras listadas en 'var' categorizadas                                                            </pre>
<pre>                              según el proceso requerido para hacer el análisis del logistic fit.                                                            </pre>
<pre>                              Todas las variables presentes en el input dataset 'dat' también están                                                            </pre>
<pre>                              presentes en este dataset de salida.                                                            </pre>
<pre>                              Los nombres de las variables categorizadas coinciden con los nombres                                                            </pre>
<pre>                              de las variables regresoras listadas en 'var'.                                                            </pre>
<pre>                              Puede pasarse cualquier opción adicional como en cualquier opción                                                            </pre>
<pre>                              data= de SAS.                                                                             </pre>
<pre>                                                                                                                        </pre>
<pre>- pred:                       Nombre de la variable en el input dataset que tiene las probabilidades                                                            </pre>
<pre>                              predichas por el modelo.                                                                  </pre>
<pre>                              default: p                                                                                </pre>
<pre>                                                                                                                        </pre>
<pre>- event:                      Evento de interés. Es el valor de la variable respuesta                                                            </pre>
<pre>                              cuya probabilidad fue modelada por la regresion logistica.                                                            </pre>
<pre>                              Puede ser cualquier valor numérico o alfanumérico.                                                            </pre>
<pre>                              default: 1                                                                                </pre>
<pre>                                                                                                                        </pre>
<pre>- groups:                     Número de grupos en los que se efectúa la categorización de las variables                                                            </pre>
<pre>                              regresoras para hacer los gráficos de ajuste.                                                            </pre>
<pre>                              Cada grupo se define a partir de percentiles equidistantes, tantos como                                                            </pre>
<pre>                              grupos haya. Por ej., si groups=5 los percentiles usados para categorizar                                                            </pre>
<pre>                              las variables son 20 40 60 80 100.                                                            </pre>
<pre>                              default: 10, es decir se utilizan los percentiles 10 20 ... 100                                                            </pre>
<pre>                                                                                                                        </pre>
<pre>- percentiles:                Valores de los percentiles utilizados para categorizar las variables                                                            </pre>
<pre>                              regresoras.                                                                               </pre>
<pre>                              Tiene preferencia sobre el parámetro groups, en el sentido de que si                                                            </pre>
<pre>                              los dos son pasados, se toma el valor de 'percentiles' y no de 'groups'.                                                            </pre>
<pre>                              default: 10 20 30 40 50 60 70 80 90 100                                                            </pre>
<pre>                                                                                                                        </pre>
<pre>- res:                        Nombre a usar para la variable que contiene el residuo estandarizado                                                            </pre>
<pre>                              calculado a partir de los gráficos de ajuste para cada variable regresora.                                                            </pre>
<pre>                              default: res                                                                              </pre>
<pre>                                                                                                                        </pre>
<pre>- suffixRes:                  Indica si se agrega el nombre de la variable regresora como sufijo al                                                            </pre>
<pre>                              nombre de la variable con el residuo estandarizado ('res'), tras un                                                            </pre>
<pre>                              '_'. Ej: si res=res, la variable regresora es x1 y suffixRes=1, el                                                            </pre>
<pre>                              nombre de la variable con el residuo es res_x1.                                                             </pre>
<pre>                              Valores posibles: 0 => No. 1 => Si.                                                            </pre>
<pre>                              default: 0                                                                                </pre>
<pre>                                                                                                                        </pre>
<pre>- plot:                       Indica si se desea ver los gráficos generados por la macro.                                                            </pre>
<pre>                              Éstos gráficos pueden incluir:                                                            </pre>
<pre>                              - Gráfico del ajuste para cada variable regresora categorizada.                                                            </pre>
<pre>                              Según el valor del parámetro 'plotWhat', en el eje vertical de estos                                                            </pre>
<pre>                              gráficos se grafica algo distinto:                                                            </pre>
<pre>                              - si plotWhat=LOGIT, se grafica el logit de la probabilidad predicha                                                            </pre>
<pre>                              y de la probabilidad observada para cada grupo de cada variable                                                            </pre>
<pre>                              regresora categorizada.                                                                   </pre>
<pre>                              - si plotWhat=P, PROB o PRED, se grafica directamente las                                                             </pre>
<pre>                              probabilidades predicha y observada.                                                            </pre>
<pre>                              - El gráfico de residuos estandarizados vs. cada variable regresora                                                            </pre>
<pre>                              categorizada.                                                                             </pre>
<pre>                              - Un histograma de los residuos estandarizados para cada variable                                                            </pre>
<pre>                              regresora categorizada (ver parámetro 'histogram').                                                            </pre>
<pre>                              - Un Normal Q-Q plot de los residuos estandarizados para cada                                                            </pre>
<pre>                              variable regresora categorizada (ver parámetro 'qqplot').                                                            </pre>
<pre>                              Valores posibles: 0 => No, 1 => Sí.                                                            </pre>
<pre>                              default: 1                                                                                </pre>
<pre>                                                                                                                        </pre>
<pre>- histogram:                  Indica si se desea ver un histograma de los residuos estandarizados                                                            </pre>
<pre>                              para cada variable regresora categorizada.                                                            </pre>
<pre>                              Valores posibles: 0 => No, 1 => Sí.                                                            </pre>
<pre>                              default: 0                                                                                </pre>
<pre>                                                                                                                        </pre>
<pre>- qqplot:                     Indica si se desea ver el Normal Q-Q plot de los residuos                                                            </pre>
<pre>                              estandarizados para cada variable regresora categorizada.                                                            </pre>
<pre>                              Se compara la distribución de los residuos con la normal estándar.                                                            </pre>
<pre>                              Valores posibles: 0 => No, 1 => Sí.                                                            </pre>
<pre>                              default: 1                                                                                </pre>
<pre>                                                                                                                        </pre>
<pre>- refline:                    Valor de la línea de referencia para el gráfico de los residuos.                                                            </pre>
<pre>                              En el gráfico de los residuos vs. variable regresora se ubican dos líneas                                                            </pre>
<pre>                              horizontales, una a la altura &RefLine y otra a -&RefLine.                                                            </pre>
<pre>                              default: 3.3                                                                              </pre>
<pre>                                                                                                                        </pre>
<pre>- pointlabels:                Indica si se desea usar labels en los puntos mostrando el número de                                                            </pre>
<pre>                              observaciones que caen en cada categoría de las variables regresoras                                                            </pre>
<pre>                              categorizadas.                                                                            </pre>
<pre>                              Valores posibles: 0 => No, 1 => Sí.                                                            </pre>
<pre>                              default: 0                                                                                </pre>
<pre>                                                                                                                        </pre>
<pre>- bars:                       Indica si se desea ver las barras de error entorno del logit de las                                                            </pre>
<pre>                              probabilidades predichas y de las proporciones del evento de interés.                                                            </pre>
<pre>                              Ver DESCRIPTION para más información sobre cómo se construyen estas barras.                                                            </pre>
<pre>                              Valores posibles: 0 => No, 1 => Sí.                                                            </pre>
<pre>                              default: 0                                                                                </pre>
<pre>                                                                                                                        </pre>
<pre>- barwidth:                   Número por el cual se multiplican los desvíos y errores estándares al                                                            </pre>
<pre>                              construir las barras de error en los gráficos logit vs. variable regresora.                                                            </pre>
<pre>                              Este parámetro tiene efecto sólo si bars=1.                                                            </pre>
<pre>                              default: 1                                                                                </pre>
<pre>                                                                                                                        </pre>
<pre>- plotWhat:                   Establece qué cantidad se desea ver en el eje vertical del gráfico                                                            </pre>
<pre>                              del ajuste por variable regresora. Las opciones son:                                                            </pre>
<pre>                              - LOGIT:                      se grafica el logit de la probabilidad.                              </pre>
<pre>                              ( logit(p) = log(p/(1-p)) )                                                               </pre>
<pre>                              - P, PROB, PRED:              se grafica la probabilidad.                                 </pre>
<pre>                              default: logit                                                                            </pre>
<pre>                                                                                                                        </pre>
<pre>- axisX:                      Valor de la opción ORDER del AXIS statement de opciones de gráfico                                                            </pre>
<pre>                              para definir la escala del eje de las X con la variable regresora                                                            </pre>
<pre>                              en los gráficos de ajuste.                                                                </pre>
<pre>                              Su valor es de la forma <min> to <max> by <step>, aunque                                                            </pre>
<pre>                              la parte del 'by' es opcional.                                                            </pre>
<pre>                                                                                                                        </pre>
<pre>- axisLogit:                  Valor de la opción ORDER del AXIS statement de opciones de gráfico                                                            </pre>
<pre>                              para definir la escala de LOGIT en el eje vertical de los gráficos                                                            </pre>
<pre>                              de ajuste.                                                                                </pre>
<pre>                              Su valor es de la forma <min> to <max> by <step>, aunque                                                            </pre>
<pre>                              la parte del 'by' es opcional.                                                            </pre>
<pre>                              Sólo tiene efecto si plotWhat=LOGIT.                                                            </pre>
<pre>                                                                                                                        </pre>
<pre>- axisPred:                   Valor de la opción ORDER del AXIS statement de opciones de gráfico                                                            </pre>
<pre>                              para definir la escala de PROBABILIDAD en el eje vertical de los gráficos                                                            </pre>
<pre>                              de ajuste.                                                                                </pre>
<pre>                              Su valor es de la forma <min> to <max> by <step>, aunque                                                            </pre>
<pre>                              la parte del 'by' es opcional.                                                            </pre>
<pre>                              Sólo tiene efecto si plotWhat=P, PROB o PRED.                                                            </pre>
<pre>                                                                                                                        </pre>
<pre>- axisRes:                    Valor de la opción ORDER del AXIS statement de opciones de gráfico                                                            </pre>
<pre>                              para definir la escala de los RESIDUOS ESTANDARIZADOS en el eje vertical                                                            </pre>
<pre>                              de los gráficos de redsiduos vs. variable regresora.                                                            </pre>
<pre>                              Su valor es de la forma <min> to <max> by <step>, aunque                                                            </pre>
<pre>                              la parte del 'by' es opcional.                                                            </pre>
<pre>                                                                                                                        </pre>
<pre>- log:                        Indica si se desea ver mensajes en el log generados por la macro.                                                            </pre>
<pre>                              Valores posibles: 0 => No, 1 => Sí.                                                            </pre>
<pre>                              default: 1                                                                                </pre>
<pre>                                                                                                                        </pre>
<h3>NOTES:</h3>
<pre>1.- En relación al ancho de las barras de error en los gráficos de logit vs. variable                                                                                          </pre>
<pre>regresora, notar que para las probabilidades predichas, la barra es proporcional al                                                                                          </pre>
<pre>DESVÍO estándar, mientras que para las probabilidades observadas el ancho de la barra                                                                                          </pre>
<pre>es proporcional al ERROR estándar (ver punto uno en "DESCRIPTION").                                                                                          </pre>
<pre>La razón de esta distinción es la siguiente: no se habla de error en el caso de las                                                                                          </pre>
<pre>probabilidades predichas porque éstas resultan de promediar los valores de las                                                                                          </pre>
<pre>probabilidades predichas dentro de cada grupo de la variable regresora. El desvío                                                                                          </pre>
<pre>estándar de estos valores es el que se usa para construir las barras de error. No se                                                                                          </pre>
<pre>tiene en cuenta en estas barras, el error estándar de cada probabilidad predicha                                                                                          </pre>
<pre>(proveniente de los errores estándares de los parámetros de regresión del modelo).                                                                                          </pre>
<pre>                                                                                                                        </pre>
<h3>OTHER MACROS AND MODULES USED IN THIS MACRO:</h3>
<pre>- %Categorize                                                                                                           </pre>
<pre>- %CheckInputParameters                                                                                                 </pre>
<pre>- %DefineSymbols                                                                                                        </pre>
<pre>- %GetNroElements                                                                                                       </pre>
<pre>- %GetStat                                                                                                              </pre>
<pre>- %GetVarList                                                                                                           </pre>
<pre>- %MakeListFromName                                                                                                     </pre>
<pre>- %Means                                                                                                                </pre>
<pre>- %Mplot                                                                                                                </pre>
<pre>- %Pretty                                                                                                               </pre>
<pre>- %Qqplot                                                                                                               </pre>
<pre>- %ResetSASOptions                                                                                                      </pre>
<pre>- %SetSASOptions                                                                                                        </pre>
<pre>- %SymmetricAxis                                                                                                        </pre>
<pre>                                                                                                                        </pre>
<h3>EXAMPLES:</h3>
<pre>1.- Dado que se realizó el siguiente PROC LOGISTIC:                                                                                          </pre>
<pre>proc logistic data=test;                                                                                                </pre>
<pre>                              model flag = x1;                                                                          </pre>
<pre>                              output out=predicted pred=pred;                                                            </pre>
<pre>run;                                                                                                                    </pre>
<pre>                                                                                                                        </pre>
<pre>La siguiente invocación a la macro analiza el ajuste en términos de las variables x1, x2:                                                                                          </pre>
<pre>                                                                                                                        </pre>
<pre>%TestLogisticFit(predicted , var=flag x1 x2 , out=fit , pred=pred , event='Acepto');                                                                                          </pre>
<pre>                                                                                                                        </pre>
<pre>Es decir, el ajuste de la regresión logística guardado en el dataset predicted, donde                                                                                          </pre>
<pre>flag es la variable respuesta, y x1, x2 son las potenciales variables regresoras, es                                                                                          </pre>
<pre>analizado.                                                                                                              </pre>
<pre>La probabilidad modelada por la regresión logística es la del evento flag='Acepto'.                                                                                          </pre>
<pre>La probabilidad predicha esta guardada en la variable 'pred' del dataset predicted.                                                                                          </pre>
<pre>La opción out= pide generar los datasets fit_x1 y fit_x2 que contienen los datos                                                                                          </pre>
<pre>usados para realizar los gráficos mostrados por la macro.                                                                                          </pre>
<body>
</html>
